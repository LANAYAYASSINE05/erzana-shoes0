{%- doc -%}
  This snippet is used to render a product card.
  It is used in the product block, featured product block, and the product card block.
  The product object is null or when placeholders are rendered.

  @param {object} product - The product object
  @param {object} children - The children of the product card
  @param {object} [block] - The block object
  @param {number} [product_card_gap] - The gap between the product card children (overrides block settings)
{%- enddoc -%}

{% assign block_settings = block.settings %}

{% style %}
  {% if request.visual_preview_mode %}
    product-card-link {
      width: 100%;
      min-width: 250px;
    }
  {% endif %}
{% endstyle %}

{% liquid
  assign has_quick_add = false
  if settings.quick_add and product.available
    assign has_quick_add = true
  endif

  assign has_mobile_quick_add = false
  if has_quick_add and settings.mobile_quick_add
    assign has_mobile_quick_add = true
  endif

  assign product_card_id = 'product-card-link-' | append: block.id | append: '-' | append: product.id
  assign product_card_gap_value = product_card_gap | default: block_settings.product_card_gap

  # Logic to determine which variant URL to use (matching swatch selection logic)
  assign variant_to_link = product.selected_or_first_available_variant
  assign combined_listing_count = product.options_with_values | map: 'values' | map: 'product_url' | compact | size
  assign no_swatch_selected = null

  unless combined_listing_count > 0
    # Simple direct check: which variant owns the featured image?
    if product.featured_media
      assign found_variant = false

      for variant in product.variants
        if variant.featured_media.id == product.featured_media.id
          assign variant_to_link = variant
          assign found_variant = true
          break
        endif
      endfor

      # Check if we need to set no_swatch_selected
      unless found_variant
        # Featured image is not a variant image
        # Check if product has swatches
        for option in product.options_with_values
          assign swatch_count = option.values | map: 'swatch' | compact | size
          if swatch_count > 1
            # Multiple swatches exist but featured image doesn't match any
            assign no_swatch_selected = true
            break
          endif
        endfor
      endunless
    endif
  endunless

  if settings.transition_to_main_product
    assign featured_image = variant_to_link.featured_image
    if featured_image == blank
      assign featured_image = product.featured_media.preview_image
    endif

    if featured_image != blank
      assign featured_media_url = featured_image | image_url: width: 500
    endif
  endif

  assign onboarding = false
  if product.id == empty or product == blank
    assign onboarding = true
  endif
%}

{%- if settings.transition_to_main_product -%}
  <product-card-link
    data-product-id="{{ product.id }}"
    data-featured-media-url="{{ featured_media_url }}"
    data-product-transition="{{ settings.transition_to_main_product }}"
    {% if onboarding %}
      data-placeholder="true"
    {% endif %}
  >
{%- endif -%}
<product-card
  class="product-card"
  data-product-id="{{ product.id }}"
  data-product-variants-size="{{ product.variants.size }}"
  id="product-card-{{ block.id }}"
  data-product-transition="{{ settings.transition_to_main_product }}"
  {{ block.shopify_attributes }}
  {% if no_swatch_selected %}
    data-no-swatch-selected="true"
  {% endif %}
  {% if onboarding %}
    data-placeholder="true"
  {% endif %}
>
  <a
    id="{{ product_card_id | md5 }}"
    {% unless onboarding %}
      href="{{ variant_to_link.url }}"
    {% endunless %}
    class="product-card__link"
    ref="productCardLink"
  >
    <span class="visually-hidden">
      {{ product.title }}
    </span>
  </a>
  <div
    class="
      product-card__content
      layout-panel-flex
      layout-panel-flex--column
      product-grid__card
      spacing-style
      border-style
      gap-style
      {% if block_settings.inherit_color_scheme == false %} color-{{ block_settings.color_scheme }}{% endif %}
      shoe-card-wrapper
    "
    style="
      {% render 'border-override', settings: block_settings %}
      {% render 'layout-panel-style', settings: block_settings %}
      {% render 'spacing-style', settings: block_settings %}
      {% render 'gap-style', value: product_card_gap_value, name: 'product-card-gap' %}
      --quick-add-display: {% if has_quick_add %}flex{% else %}none{% endif %};
      --quick-add-mobile-display: {% if has_mobile_quick_add %}flex{% else %}none{% endif %};
      {% if block_settings.padding-inline-start > 0 %}--zoom-out-padding-inline-start: min(var(--padding-xs), {{ block_settings.padding-inline-start | times: 0.7}}px);{% endif %}
      {% if block_settings.padding-inline-end > 0 %}--zoom-out-padding-inline-end: min(var(--padding-xs), {{ block_settings.padding-inline-end | times: 0.7}}px);{% endif %}
      {% if block_settings.padding-block-start > 0 %}--zoom-out-padding-block-start: min(var(--padding-xs), {{ block_settings.padding-block-start | times: 0.7}}px);{% endif %}
      {% if block_settings.padding-block-end > 0 %}--zoom-out-padding-block-end: min(var(--padding-xs), {{ block_settings.padding-block-end | times: 0.7}}px);{% endif %}
    "
  >
    {%- unless onboarding -%}
      <div class="shoe-card__header">
        <span class="shoe-card__subtitle">CONFORT MAÎTRISÉ</span>
        <div class="shoe-card__badges">
          {%- if product.compare_at_price > product.price -%}
            <span class="badge badge--promo">
              <svg width="8" height="8" viewBox="0 0 8 8" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: inline-block; margin-right: 2px; vertical-align: middle;">
                <rect x="1.5" y="2.5" width="5" height="4" fill="white" opacity="0.9"/>
                <path d="M4 1.5L2.5 2.5L4 3.5L5.5 2.5L4 1.5Z" fill="white"/>
                <path d="M1.5 2.5L4 1.5L6.5 2.5" stroke="white" stroke-width="0.3"/>
              </svg>
              PROMO 3D<br>EXCLUSIVE
            </span>
          {%- endif -%}
          {%- comment -%} Check if product is new (created within last 30 days) {%- endcomment -%}
          {%- assign current_timestamp = 'now' | date: '%s' | plus: 0 -%}
          {%- assign product_timestamp = product.created_at | date: '%s' | plus: 0 -%}
          {%- assign days_old = current_timestamp | minus: product_timestamp | divided_by: 86400 -%}
          {%- if days_old < 30 and days_old >= 0 -%}
            <span class="badge badge--new">NEW</span>
          {%- endif -%}
          <span class="badge badge--light">
            LÉGER
            <svg width="10" height="10" viewBox="0 0 10 10" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: inline-block; margin-left: 3px; vertical-align: middle;">
              <path d="M5 1L4 3L2 4L4 5L5 7L6 5L8 4L6 3L5 1Z" stroke="white" stroke-width="0.5" fill="white" opacity="0.9"/>
            </svg>
          </span>
        </div>
      </div>
    {%- endunless -%}
    
    <div class="shoe-card__image-section">
      {% if children != blank %}
        {{ children }}
      {% elsif product and product != blank %}
        {% render 'card-gallery', section: section, block: block %}
      {% endif %}
    </div>
    
    {%- unless onboarding -%}
      <div class="shoe-card__info">
        <div class="shoe-card__title">{{ product.title | upcase }}</div>
        <div class="shoe-card__price">
          {% render 'price', product_resource: product %}
        </div>
      </div>
      
      {%- assign size_option = product.options_with_values | where: 'name', 'Size' | first -%}
      {%- if size_option == blank -%}
        {%- assign size_option = product.options_with_values | first -%}
      {%- endif -%}
      {%- if size_option and size_option.values.size > 0 -%}
        <div class="shoe-card__sizes">
          {%- for value in size_option.values limit: 4 -%}
            <button class="size-btn" type="button" data-size="{{ value }}">{{ value }}</button>
          {%- endfor -%}
        </div>
      {%- endif -%}
    {%- endunless -%}
  </div>
</product-card>
{%- if settings.transition_to_main_product -%}
  </product-card-link>
{%- endif -%}

{% stylesheet %}
  product-card-link,
  :not(product-card-link) product-card {
    width: 100%;
  }

  .product-card__placeholder-image svg {
    height: 100%;
  }

  @media screen and (max-width: 749px) {
    .product-card slideshow-arrows .slideshow-control {
      display: none;
    }
  }

  /* Hide the variant swatches for product cards that show a swatches variant picker */
  :is(.product-card):has(swatches-variant-picker-component) .quick-add .variant-option--swatches {
    display: none;
  }

  /* Hide "Add" button for single option product cards that show a swatches variant picker */
  :is(.product-card:not([data-no-swatch-selected])):has(.quick-add__product-form-component--single-option):has(
      swatches-variant-picker-component
    )
    .quick-add__button--choose {
    display: none;
  }

  /* Hide "Add" button for single option product cards that show a swatches variant picker */
  :is(.product-card[data-no-swatch-selected]):has(.quick-add__product-form-component--single-option):has(
      swatches-variant-picker-component
    )
    add-to-cart-component {
    display: none;
  }

  /* Hide "add" button for multi-variant product cards that don't show a swatches variant picker */
  :is(.product-card):has(.quick-add__product-form-component--multi-variant):not(:has(swatches-variant-picker-component))
    .quick-add__button--add {
    display: none;
  }

  /* Hover effect for single variant product cards and product blocks */

  /* stylelint-disable selector-max-specificity */
  :is(.product-card):has(.quick-add__product-form-component--single-variant) .card-gallery:hover {
    & .quick-add__button--choose {
      display: none;
    }

    & .quick-add__button--add {
      display: grid;
    }
  }

  .product-card[data-no-swatch-selected] slideshow-component[data-generic-media-size='1'] slideshow-arrows {
    display: none;
  }

  .product-card[data-no-swatch-selected]
    slideshow-component[data-generic-media-size='1']
    slideshow-arrows:has(+ slideshow-slides slideshow-slide[variant-image]:not([hidden])) {
    display: flex;
  }

  .product-card .variant-option__swatch svg {
    display: none;
  }

  .product-card [data-available-count='0'] ~ svg {
    display: block;
  }

  /* Shoe Card Design Styles */
  .shoe-card-wrapper {
    position: relative;
    background: #fff;
    padding: 16px 18px 20px;
    width: 100%;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  }

  .shoe-card__header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 10px;
    position: relative;
    z-index: 2;
  }

  .shoe-card__subtitle {
    font-size: 11px;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: #333;
    font-weight: 500;
  }

  .shoe-card__badges {
    display: flex;
    flex-direction: column;
    gap: 4px;
    align-items: flex-end;
  }

  .badge {
    font-size: 9px;
    line-height: 1.2;
    text-transform: uppercase;
    color: #fff;
    padding: 3px 6px;
    border-radius: 2px;
    text-align: center;
    font-weight: 600;
    white-space: nowrap;
  }

  .badge--promo {
    background: #c0171c;
    display: flex;
    align-items: center;
    justify-content: center;
    white-space: normal;
    line-height: 1.1;
  }

  .badge--promo svg {
    flex-shrink: 0;
    align-self: flex-start;
    margin-top: 1px;
  }

  .badge--new {
    background: #444;
  }

  .badge--light {
    background: #006da7;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .badge--light svg {
    flex-shrink: 0;
  }

  .shoe-card__image-section {
    position: relative;
    margin: 8px 0 12px;
    padding: 10px 0 22px;
  }

  .shoe-card__image-section .card-gallery {
    position: relative;
    z-index: 1;
  }

  /* Hide duplicate title and price from children if they exist */
  .shoe-card-wrapper .shoe-card__image-section ~ * product-title,
  .shoe-card-wrapper .shoe-card__image-section ~ * product-price {
    display: none;
  }

  /* Ensure our styled title and price are visible */
  .shoe-card__info {
    display: block;
  }

  .shoe-card__info {
    margin-bottom: 10px;
    text-align: center;
  }

  .shoe-card__title {
    font-size: 13px;
    font-weight: 600;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    margin-bottom: 4px;
    color: #000;
  }

  .shoe-card__price {
    font-size: 16px;
    font-weight: 700;
    color: #000;
  }

  .shoe-card__price .price {
    font-size: 16px;
    font-weight: 700;
  }

  .shoe-card__sizes {
    display: flex;
    justify-content: center;
    gap: 6px;
    flex-wrap: wrap;
  }

  .size-btn {
    min-width: 34px;
    height: 26px;
    border-radius: 3px;
    border: 1px solid #999;
    background: #fff;
    font-size: 11px;
    cursor: pointer;
    color: #000;
    transition: all 0.2s ease;
    font-weight: 500;
  }

  .size-btn:hover {
    border-color: #000;
    background: #f5f5f5;
  }

  .size-btn:active {
    background: #000;
    color: #fff;
  }

  @media screen and (max-width: 749px) {
    .shoe-card-wrapper {
      padding: 12px 14px 16px;
    }

    .shoe-card__subtitle {
      font-size: 10px;
    }

    .badge {
      font-size: 8px;
      padding: 2px 5px;
    }

    .shoe-card__title {
      font-size: 12px;
    }

    .shoe-card__price {
      font-size: 14px;
    }

    .size-btn {
      min-width: 30px;
      height: 24px;
      font-size: 10px;
    }
  }
{% endstylesheet %}
